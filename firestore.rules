rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== FUNCIONES HELPER ====================
    
    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar si es el dueño del recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Verificar si es asistente
    function esAsistente() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.role == 'asistente';
    }
    
    // Obtener pacienteId del asistente
    function pacienteIdDelAsistente() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.pacienteId;
    }
    
    // Validar formato de horario (HH:mm)
    function isValidTimeFormat(time) {
      return time is string && 
             time.matches('^([0-1][0-9]|2[0-3]):[0-5][0-9]$');
    }
    
    // Validar presentación válida
    function isValidPresentacion(presentacion) {
      return presentacion is string && 
             presentacion in ['Comprimidos', 'Cápsulas', 'Jarabe', 'Crema', 
                             'Pomada', 'Spray nasal', 'Inyección', 'Gotas', 'Parche'];
    }
    
    // Validar datos de medicamento
    function isValidMedicamento() {
      let data = request.resource.data;
      
      // Validar campos requeridos
      return data.nombre is string && 
             data.nombre.size() > 0 && 
             data.nombre.size() <= 100 &&
             data.userId is string &&
             data.userId == request.auth.uid && // ✅ CRÍTICO: userId debe ser del usuario autenticado
             data.presentacion is string &&
             isValidPresentacion(data.presentacion) &&
             data.tomasDiarias is int &&
             data.tomasDiarias >= 1 &&
             data.tomasDiarias <= 24 && // Máximo razonable: 24 tomas al día
             data.horarioPrimeraToma is string &&
             isValidTimeFormat(data.horarioPrimeraToma) &&
             data.stockInicial is int &&
             data.stockInicial >= 0 &&
             data.stockInicial <= 10000 && // Límite razonable
             data.stockActual is int &&
             data.stockActual >= 0 &&
             data.stockActual <= 10000 &&
             data.stockActual <= data.stockInicial && // stockActual no puede ser mayor que stockInicial
             data.color is int &&
             data.color >= 0 &&
             data.diasTratamiento is int &&
             (data.diasTratamiento == -1 || (data.diasTratamiento >= 1 && data.diasTratamiento <= 3650)) && // -1 para crónico, o entre 1 y 10 años
             data.activo is bool &&
             data.pausado is bool &&
             // Campos opcionales
             (!('afeccion' in data) || (data.afeccion is string && data.afeccion.size() <= 200)) &&
             (!('detalles' in data) || (data.detalles is string && data.detalles.size() <= 1000));
    }
    
    // Validar que no se cambien campos inmutables en update
    function camposInmutablesNoCambiaron() {
      let data = request.resource.data;
      let oldData = resource.data;
      
      return data.userId == oldData.userId && // ✅ No se puede cambiar userId
             data.fechaCreacion == oldData.fechaCreacion; // ✅ No se puede cambiar fechaCreacion
    }
    
    // Validar datos de toma
    function isValidToma() {
      let data = request.resource.data;
      
      return data.userId is string &&
             data.userId == request.auth.uid && // ✅ CRÍTICO: userId debe ser del usuario autenticado
             data.medicamentoId is string &&
             data.medicamentoId.size() > 0 &&
             data.medicamentoNombre is string &&
             data.medicamentoNombre.size() > 0 &&
             data.estado is string &&
             data.estado in ['TOMADA', 'PERDIDA', 'PENDIENTE'] &&
             data.fechaHoraProgramada is timestamp &&
             (!('fechaHoraTomada' in data) || data.fechaHoraTomada is timestamp) &&
             (!('observaciones' in data) || (data.observaciones is string && data.observaciones.size() <= 500));
    }
    
    // Validar datos de usuario
    function isValidUsuario() {
      let data = request.resource.data;
      
      return data.nombre is string &&
             data.nombre.size() > 0 &&
             data.nombre.size() <= 100 &&
             data.email is string &&
             data.email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$') &&
             (!('telefono' in data) || (data.telefono is string && data.telefono.size() <= 20)) &&
             (!('edad' in data) || (data.edad is int && data.edad >= 0 && data.edad <= 150)) &&
             (!('role' in data) || (data.role is string && data.role in ['paciente', 'asistente']));
    }
    
    // ==================== REGLAS PARA USUARIOS ====================
    
    match /usuarios/{userId} {
      // Leer: solo el mismo usuario o su asistente
      allow read: if isAuthenticated() && 
                     (isOwner(userId) || 
                      (esAsistente() && pacienteIdDelAsistente() == userId));
      
      // Crear: solo el mismo usuario, datos válidos
      allow create: if isAuthenticated() && 
                       userId == request.auth.uid &&
                       isValidUsuario();
      
      // Actualizar: solo el mismo usuario, datos válidos, no cambiar userId
      allow update: if isAuthenticated() && 
                       isOwner(userId) &&
                       isValidUsuario() &&
                       request.resource.data.userId == resource.data.userId; // ✅ No cambiar userId si existe
      
      // Eliminar: solo el mismo usuario
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // ==================== REGLAS PARA MEDICAMENTOS ====================
    
    match /medicamentos/{medicamentoId} {
      // Leer: solo el dueño o su asistente
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid ||
                      (esAsistente() && pacienteIdDelAsistente() == resource.data.userId));
      
      // Crear: usuario autenticado, datos válidos, userId correcto
      allow create: if isAuthenticated() && 
                       isValidMedicamento() &&
                       request.resource.data.userId == request.auth.uid; // ✅ Servidor valida userId
      
      // Actualizar: solo el dueño, datos válidos, campos inmutables no cambiaron
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       isValidMedicamento() &&
                       camposInmutablesNoCambiaron(); // ✅ Prevenir cambios no autorizados
      
      // Eliminar: solo el dueño
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }
    
    // ==================== REGLAS PARA ASISTENTES ====================
    
    match /asistentes/{asistenteId} {
      // Leer: cualquier usuario autenticado (necesario para verificar si es asistente)
      // O el paciente dueño, o el asistente mismo
      allow read: if isAuthenticated() && 
                     (resource.data.pacienteId == request.auth.uid ||
                      request.auth.uid == asistenteId ||
                      esAsistente());
      
      // Crear: paciente autenticado, pacienteId correcto
      allow create: if isAuthenticated() && 
                       request.resource.data.pacienteId == request.auth.uid &&
                       request.resource.data.pacienteId is string &&
                       request.resource.data.pacienteId.size() > 0;
      
      // Eliminar: solo el paciente dueño
      allow delete: if isAuthenticated() && 
                       resource.data.pacienteId == request.auth.uid;
    }
    
    // ==================== REGLAS PARA TOKENS DE GOOGLE CALENDAR ====================
    
    match /googleTokens/{userId} {
      // Solo el mismo usuario puede leer y escribir su token
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
    
    // ==================== REGLAS PARA TOMAS ====================
    
    match /tomas/{tomaId} {
      // Leer: solo el dueño o su asistente
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid ||
                      (esAsistente() && pacienteIdDelAsistente() == resource.data.userId));
      
      // Crear: usuario autenticado, datos válidos, userId correcto
      allow create: if isAuthenticated() && 
                       isValidToma() &&
                       request.resource.data.userId == request.auth.uid; // ✅ Servidor valida userId
      
      // Actualizar: solo el dueño, datos válidos, no cambiar userId
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       isValidToma() &&
                       request.resource.data.userId == resource.data.userId; // ✅ No cambiar userId
      
      // Eliminar: solo el dueño
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }
  }
}

